<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/org/civworld/brainrots/listener/NpcListener.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/org/civworld/brainrots/listener/NpcListener.java" />
              <option name="originalContent" value="package org.civworld.brainrots.listener;&#10;&#10;import net.citizensnpcs.api.CitizensAPI;&#10;import net.citizensnpcs.api.event.CitizensEnableEvent;&#10;import net.citizensnpcs.api.event.NPCRightClickEvent;&#10;import net.citizensnpcs.api.npc.NPC;&#10;import net.milkbowl.vault.economy.Economy;&#10;import org.apache.commons.lang3.tuple.Pair;&#10;import org.bukkit.Bukkit;&#10;import org.bukkit.Location;&#10;import org.bukkit.NamespacedKey;&#10;import org.bukkit.SoundCategory;&#10;import org.bukkit.entity.Player;&#10;import org.bukkit.event.EventHandler;&#10;import org.bukkit.event.Listener;&#10;import org.civworld.brainrots.data.PlayerData;&#10;import org.civworld.brainrots.model.BrainrotModel;&#10;import org.civworld.brainrots.model.House;&#10;import org.civworld.brainrots.model.Lobby;&#10;import org.civworld.brainrots.puller.Puller;&#10;import org.civworld.brainrots.repo.LobbyRepo;&#10;import org.civworld.brainrots.type.Modificator;&#10;&#10;import java.util.Map;&#10;import java.util.concurrent.ConcurrentHashMap;&#10;&#10;import static org.civworld.brainrots.util.Utils.parse;&#10;&#10;public class NpcListener implements Listener {&#10;    private final Economy economy;&#10;    private final Puller puller;&#10;    private final LobbyRepo lobbyRepo;&#10;&#10;    private final Map&lt;NPC, Long&gt; npcSoundCooldowns = new ConcurrentHashMap&lt;&gt;();&#10;    private static final long SOUND_COOLDOWN = 1000;&#10;&#10;    public NpcListener(Economy economy, Puller puller, LobbyRepo lobbyRepo){&#10;        this.economy = economy;&#10;        this.puller = puller;&#10;        this.lobbyRepo = lobbyRepo;&#10;    }&#10;&#10;    @EventHandler&#10;    public void onLoad(CitizensEnableEvent event){&#10;        for(NPC npc : CitizensAPI.getNPCRegistry()){&#10;            if(npc.getName().equals(&quot;putevoditel&quot;) || npc.getName().equals(&quot;quests&quot;)) continue;&#10;            npc.despawn();&#10;            npc.destroy();&#10;            CitizensAPI.getNPCRegistry().deregister(npc);&#10;        }&#10;        Bukkit.dispatchCommand(Bukkit.getConsoleSender(), &quot;citizens save&quot;);&#10;    }&#10;&#10;    @EventHandler&#10;    public void onClick(NPCRightClickEvent event){&#10;        Player clicker = event.getClicker();&#10;        NPC npc = event.getNPC();&#10;&#10;        House house = null;&#10;        PlayerData playerData = null;&#10;        // ищем дом конкретного кликающего игрока в доступных лобби&#10;        for(Lobby l : lobbyRepo.getLobbies()){&#10;            for(House h : l.getHouses()){&#10;                PlayerData pd = h.getPlayerData();&#10;                if(pd == null) continue;&#10;                if (pd.getPlayer().equals(clicker)){&#10;                    playerData = pd;&#10;                    house = h;&#10;                    break;&#10;                }&#10;            }&#10;            if (house != null) break;&#10;        }&#10;&#10;        if(playerData == null){&#10;            clicker.sendMessage(parse(&quot;&lt;prefix&gt;Вы &lt;red&gt;не состоите&lt;white&gt; в &lt;blue&gt;лобби&lt;white&gt;!&quot;));&#10;            return;&#10;        }&#10;&#10;        Pair&lt;BrainrotModel, Modificator&gt; pair = puller.getWalkingNpc().getOrDefault(npc, null);&#10;        if(pair == null) return;&#10;&#10;        BrainrotModel brainrotModel = pair.getKey();&#10;        if(brainrotModel == null) return;&#10;&#10;        Modificator modificator = pair.getValue();&#10;        double cost = modificator == Modificator.BRONZE ? brainrotModel.getCost() : brainrotModel.getCost() * modificator.getValue();&#10;        String costFormatted = formatDouble(cost);&#10;&#10;        if(economy.getBalance(clicker) &lt; cost){&#10;            clicker.sendMessage(parse(&quot;&lt;prefix&gt;Недостаточно &lt;red&gt;монет&lt;white&gt;!&quot;));&#10;            return;&#10;        }&#10;&#10;        clicker.sendMessage(parse(&quot;&lt;prefix&gt;Вам &lt;green&gt;хватает &lt;white&gt;монет: &lt;blue&gt;&quot; + costFormatted));&#10;&#10;        long now = System.currentTimeMillis();&#10;        Long last = npcSoundCooldowns.get(npc);&#10;&#10;        if(last == null || now - last &gt;= SOUND_COOLDOWN){&#10;            for (Player p : npc.getEntity().getWorld().getPlayers()) {&#10;                if (p.getLocation().distance(npc.getStoredLocation()) &lt;= 16) {&#10;                    p.playSound(&#10;                            npc.getStoredLocation(),&#10;                            &quot;brainrot:sound.&quot; + brainrotModel.getId(),&#10;                            SoundCategory.BLOCKS,&#10;                            1.0f,&#10;                            1.0f&#10;                    );&#10;                }&#10;            }&#10;            npcSoundCooldowns.put(npc, now);&#10;        }&#10;&#10;        Location newLoc = house.getPlateCloseDoor().clone().add(0, -1, house.isRight() ? 26 : -26);&#10;        economy.withdrawPlayer(clicker, cost);&#10;        clicker.sendMessage(parse(&quot;&lt;prefix&gt;С вас &lt;gold&gt;&quot; + costFormatted + &quot;&lt;white&gt; монет &lt;green&gt;списано&lt;white&gt;!&quot;));&#10;        clicker.sendMessage(parse(&quot;&lt;prefix&gt;Нпс идёт по координатам &quot; + newLoc.getX() + &quot; &quot; + newLoc.getY() + &quot; &quot; + newLoc.getZ()));&#10;        // плавное перемещение NPC небольшими шагами (значение шага можно регулировать)&#10;        puller.moveNpcSmooth(npc, newLoc, 1.0);&#10;    }&#10;&#10;    public static String formatDouble(double value) {&#10;        java.text.DecimalFormat df = new java.text.DecimalFormat(&quot;#.################&quot;);&#10;        df.setGroupingUsed(false);&#10;        return df.format(value);&#10;    }&#10;}" />
              <option name="updatedContent" value="package org.civworld.brainrots.listener;&#10;&#10;import net.citizensnpcs.api.CitizensAPI;&#10;import net.citizensnpcs.api.event.CitizensEnableEvent;&#10;import net.citizensnpcs.api.event.NPCRightClickEvent;&#10;import net.citizensnpcs.api.npc.NPC;&#10;import net.milkbowl.vault.economy.Economy;&#10;import org.apache.commons.lang3.tuple.Pair;&#10;import org.bukkit.Bukkit;&#10;import org.bukkit.Location;&#10;import org.bukkit.NamespacedKey;&#10;import org.bukkit.SoundCategory;&#10;import org.bukkit.entity.Player;&#10;import org.bukkit.event.EventHandler;&#10;import org.bukkit.event.Listener;&#10;import org.civworld.brainrots.data.PlayerData;&#10;import org.civworld.brainrots.model.BrainrotModel;&#10;import org.civworld.brainrots.model.House;&#10;import org.civworld.brainrots.model.Lobby;&#10;import org.civworld.brainrots.puller.Puller;&#10;import org.civworld.brainrots.repo.LobbyRepo;&#10;import org.civworld.brainrots.type.Modificator;&#10;&#10;import java.util.Map;&#10;import java.util.concurrent.ConcurrentHashMap;&#10;&#10;import static org.civworld.brainrots.util.Utils.parse;&#10;&#10;public class NpcListener implements Listener {&#10;    private final Economy economy;&#10;    private final Puller puller;&#10;    private final LobbyRepo lobbyRepo;&#10;&#10;    private final Map&lt;NPC, Long&gt; npcSoundCooldowns = new ConcurrentHashMap&lt;&gt;();&#10;    private static final long SOUND_COOLDOWN = 1000;&#10;&#10;    public NpcListener(Economy economy, Puller puller, LobbyRepo lobbyRepo){&#10;        this.economy = economy;&#10;        this.puller = puller;&#10;        this.lobbyRepo = lobbyRepo;&#10;    }&#10;&#10;    @EventHandler&#10;    public void onLoad(CitizensEnableEvent event){&#10;        for(NPC npc : CitizensAPI.getNPCRegistry()){&#10;            if(npc.getName().equals(&quot;putevoditel&quot;) || npc.getName().equals(&quot;quests&quot;)) continue;&#10;            npc.despawn();&#10;            npc.destroy();&#10;            CitizensAPI.getNPCRegistry().deregister(npc);&#10;        }&#10;        Bukkit.dispatchCommand(Bukkit.getConsoleSender(), &quot;citizens save&quot;);&#10;    }&#10;&#10;    @EventHandler&#10;    public void onClick(NPCRightClickEvent event){&#10;        Player clicker = event.getClicker();&#10;        NPC npc = event.getNPC();&#10;&#10;        House house = null;&#10;        PlayerData playerData = null;&#10;        // ищем дом конкретного кликающего игрока в доступных лобби&#10;        for(Lobby l : lobbyRepo.getLobbies()){&#10;            for(House h : l.getHouses()){&#10;                PlayerData pd = h.getPlayerData();&#10;                if(pd == null) continue;&#10;                if (pd.getPlayer().equals(clicker)){&#10;                    playerData = pd;&#10;                    house = h;&#10;                    break;&#10;                }&#10;            }&#10;            if (house != null) break;&#10;        }&#10;&#10;        if(playerData == null){&#10;            clicker.sendMessage(parse(&quot;&lt;prefix&gt;Вы &lt;red&gt;не состоите&lt;white&gt; в &lt;blue&gt;лобби&lt;white&gt;!&quot;));&#10;            return;&#10;        }&#10;&#10;        Pair&lt;BrainrotModel, Modificator&gt; pair = puller.getWalkingNpc().getOrDefault(npc, null);&#10;        if(pair == null) return;&#10;&#10;        BrainrotModel brainrotModel = pair.getKey();&#10;        if(brainrotModel == null) return;&#10;&#10;        Modificator modificator = pair.getValue();&#10;        double cost = modificator == Modificator.BRONZE ? brainrotModel.getCost() : brainrotModel.getCost() * modificator.getValue();&#10;        String costFormatted = formatDouble(cost);&#10;&#10;        if(economy.getBalance(clicker) &lt; cost){&#10;            clicker.sendMessage(parse(&quot;&lt;prefix&gt;Недостаточно &lt;red&gt;монет&lt;white&gt;!&quot;));&#10;            return;&#10;        }&#10;&#10;        clicker.sendMessage(parse(&quot;&lt;prefix&gt;Вам &lt;green&gt;хватает &lt;white&gt;монет: &lt;blue&gt;&quot; + costFormatted));&#10;&#10;        long now = System.currentTimeMillis();&#10;        Long last = npcSoundCooldowns.get(npc);&#10;&#10;        if(last == null || now - last &gt;= SOUND_COOLDOWN){&#10;            for (Player p : npc.getEntity().getWorld().getPlayers()) {&#10;                if (p.getLocation().distance(npc.getStoredLocation()) &lt;= 16) {&#10;                    p.playSound(&#10;                            npc.getStoredLocation(),&#10;                            &quot;brainrot:sound.&quot; + brainrotModel.getId(),&#10;                            SoundCategory.BLOCKS,&#10;                            1.0f,&#10;                            1.0f&#10;                    );&#10;                }&#10;            }&#10;            npcSoundCooldowns.put(npc, now);&#10;        }&#10;&#10;        Location newLoc = house.getPlateCloseDoor().clone().add(0, -1, house.isRight() ? 26 : -26);&#10;        economy.withdrawPlayer(clicker, cost);&#10;        clicker.sendMessage(parse(&quot;&lt;prefix&gt;С вас &lt;gold&gt;&quot; + costFormatted + &quot;&lt;white&gt; монет &lt;green&gt;списано&lt;white&gt;!&quot;));&#10;        clicker.sendMessage(parse(&quot;&lt;prefix&gt;Нпс идёт по координатам &quot; + newLoc.getX() + &quot; &quot; + newLoc.getY() + &quot; &quot; + newLoc.getZ()));&#10;        // плавное перемещение NPC небольшими шагами (значение шага можно регулировать)&#10;        puller.moveNpcSmooth(npc, newLoc, 1.0);&#10;    }&#10;&#10;    public static String formatDouble(double value) {&#10;        java.text.DecimalFormat df = new java.text.DecimalFormat(&quot;#.################&quot;);&#10;        df.setGroupingUsed(false);&#10;        return df.format(value);&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>